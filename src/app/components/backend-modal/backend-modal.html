<div class="modal-overlay" (click)="close()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- HEADER DINÂMICO -->
    <div class="modal-header">
      <div class="modal-title-section">
        <h2 class="modal-title">{{ modalTitle }}</h2>
        <span class="status-badge" [ngClass]="getStatusClass()" *ngIf="isViewMode || backend">
          {{ isViewMode ? backend?.status : backendForm.get('status')?.value }}
        </span>
      </div>
      <button class="close-btn" (click)="close()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <!-- MODO VISUALIZAÇÃO -->
    <div class="modal-body" *ngIf="isViewMode && backend">
      <div class="service-overview">
        <p class="service-description">{{ backend.description }}</p>
      </div>

      <div class="features-section">
        <h3 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="20,6 9,17 4,12"></polyline>
          </svg>
          Funcionalidades
        </h3>
        
        <div class="features-list" *ngIf="getFeatures().length > 0; else noFeatures">
          <div class="feature-item" *ngFor="let feature of getFeatures()">
            <div class="feature-bullet">•</div>
            <div class="feature-content">{{ feature }}</div>
          </div>
        </div>
        
        <ng-template #noFeatures>
          <div class="no-data">
            Nenhuma funcionalidade especificada para este backend.
          </div>
        </ng-template>
      </div>

      <div class="details-grid">
        <div class="detail-card">
          <div class="detail-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 3.09V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>Detalhes Técnicos</span>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="detail-label">Versão:</span>
              <span class="detail-value">{{ backend.version }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Ambiente:</span>
              <span class="detail-value environment-badge" [ngClass]="getEnvironmentClass()">
                {{ backend.environment }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">APIs Disponíveis:</span>
              <span class="detail-value">{{ backend.apis }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Uptime:</span>
              <span class="detail-value uptime" [ngClass]="getUptimeClass()">
                {{ backend.uptime }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Última Atualização:</span>
              <span class="detail-value">
                {{ backend.lastUpdate | date:'dd/MM/yyyy HH:mm' }}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
              <line x1="16" y1="8" x2="2" y2="22"></line>
              <line x1="17.5" y1="15" x2="9" y2="15"></line>
            </svg>
            <span>Tags</span>
          </div>
          <div class="detail-content">
            <div class="tags-container" *ngIf="getTags().length > 0; else noTags">
              <span class="tag" *ngFor="let tag of getTags()">{{ tag }}</span>
            </div>
            
            <ng-template #noTags>
              <div class="no-data">
                Nenhuma tag atribuída a este backend.
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- RESULTADO TESTE DE CONEXÃO -->
      <div class="connection-result" *ngIf="connectionResult">
        <div class="connection-card" [ngClass]="connectionResult.success ? 'success' : 'error'">
          <div class="connection-icon">
            <svg *ngIf="connectionResult.success" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
            <svg *ngIf="!connectionResult.success" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <div class="connection-content">
            <p class="connection-message">{{ connectionResult.message }}</p>
            <p class="connection-time" *ngIf="connectionResult.responseTime">
              Tempo de resposta: {{ connectionResult.responseTime }}ms
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- MODO EDIÇÃO/CRIAÇÃO -->
    <div class="modal-body" *ngIf="isEditMode || isCreateMode">
      <form [formGroup]="backendForm" class="backend-form">
        <!-- Informações Básicas -->
        <div class="form-section">
          <h3 class="section-title">Informações Básicas</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="name">Nome do Backend *</label>
              <input 
                id="name"
                type="text" 
                formControlName="name" 
                class="form-input"
                [class.error]="isFieldInvalid('name')"
                placeholder="Ex: Auth Service">
              <span class="error-message" *ngIf="isFieldInvalid('name')">
                {{ getFieldError('name') }}
              </span>
            </div>

            <div class="form-group">
              <label for="version">Versão *</label>
              <input 
                id="version"
                type="text" 
                formControlName="version" 
                class="form-input"
                [class.error]="isFieldInvalid('version')"
                placeholder="Ex: v1.2.3">
              <span class="error-message" *ngIf="isFieldInvalid('version')">
                {{ getFieldError('version') }}
              </span>
            </div>
          </div>

          <div class="form-group">
            <label for="description">Descrição *</label>
            <textarea 
              id="description"
              formControlName="description" 
              class="form-textarea"
              [class.error]="isFieldInvalid('description')"
              rows="3"
              placeholder="Descreva as funcionalidades principais deste backend..."></textarea>
            <span class="error-message" *ngIf="isFieldInvalid('description')">
              {{ getFieldError('description') }}
            </span>
          </div>
        </div>

        <!-- Configurações -->
        <div class="form-section">
          <h3 class="section-title">Configurações</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="environment">Ambiente *</label>
              <select id="environment" formControlName="environment" class="form-select">
                <option value="Development">Development</option>
                <option value="Staging">Staging</option>
                <option value="Production">Production</option>
              </select>
            </div>

            <div class="form-group">
              <label for="status">Status *</label>
              <select id="status" formControlName="status" class="form-select">
                <option value="Healthy">Saudável</option>
                <option value="Warning">Aviso</option>
                <option value="Error">Erro</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="uptime">Uptime *</label>
              <input 
                id="uptime"
                type="text" 
                formControlName="uptime" 
                class="form-input"
                [class.error]="isFieldInvalid('uptime')"
                placeholder="Ex: 99.9%">
              <span class="error-message" *ngIf="isFieldInvalid('uptime')">
                {{ getFieldError('uptime') }}
              </span>
            </div>

            <div class="form-group">
              <label for="apis">Número de APIs *</label>
              <input 
                id="apis"
                type="number" 
                formControlName="apis" 
                class="form-input"
                [class.error]="isFieldInvalid('apis')"
                min="1"
                placeholder="Ex: 8">
              <span class="error-message" *ngIf="isFieldInvalid('apis')">
                {{ getFieldError('apis') }}
              </span>
            </div>
          </div>
        </div>

        <!-- Tags -->
        <div class="form-section">
          <h3 class="section-title">Tags</h3>
          
          <div class="tags-input-container">
            <input 
              type="text" 
              [(ngModel)]="newTag" 
              [ngModelOptions]="{standalone: true}"
              class="form-input"
              placeholder="Adicionar tag..."
              (keypress)="onTagKeyPress($event)">
            <button type="button" class="btn-add" (click)="addTag()" [disabled]="!newTag.trim()">
              Adicionar
            </button>
          </div>

          <div class="tags-list" *ngIf="tagsArray.length > 0">
            <div class="tag-item" *ngFor="let tag of tagsArray.controls; let i = index">
              <span class="tag-text">{{ tag.value }}</span>
              <button type="button" class="tag-remove" (click)="removeTag(i)">×</button>
            </div>
          </div>
        </div>

        <!-- Features -->
        <div class="form-section">
          <h3 class="section-title">Funcionalidades</h3>
          
          <div class="feature-input-container">
            <textarea 
              [(ngModel)]="newFeature"
              [ngModelOptions]="{standalone: true}"
              class="form-textarea"
              rows="2"
              placeholder="Descreva uma funcionalidade..."
              (keypress)="onFeatureKeyPress($event)"></textarea>
            <button type="button" class="btn-add" (click)="addFeature()" [disabled]="!newFeature.trim()">
              Adicionar
            </button>
          </div>

          <div class="features-list" *ngIf="featuresArray.length > 0">
            <div class="feature-item-editable" *ngFor="let feature of featuresArray.controls; let i = index">
              <div class="feature-bullet">•</div>
              <div class="feature-content">{{ feature.value }}</div>
              <button type="button" class="feature-remove" (click)="removeFeature(i)">×</button>
            </div>
          </div>
        </div>

        <!-- RESULTADO TESTE DE CONEXÃO NO FORM -->
        <div class="connection-result" *ngIf="connectionResult">
          <div class="connection-card" [ngClass]="connectionResult.success ? 'success' : 'error'">
            <div class="connection-icon">
              <svg *ngIf="connectionResult.success" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              <svg *ngIf="!connectionResult.success" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </div>
            <div class="connection-content">
              <p class="connection-message">{{ connectionResult.message }}</p>
              <p class="connection-time" *ngIf="connectionResult.responseTime">
                Tempo de resposta: {{ connectionResult.responseTime }}ms
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- FOOTER DINÂMICO - SUBSTITUA APENAS ESTA PARTE -->
    <div class="modal-footer">
      <!-- MODO VISUALIZAÇÃO -->
      <ng-container *ngIf="isViewMode">
        <button type="button" class="btn-danger" (click)="deleteBackend()" [disabled]="isDeleting">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" *ngIf="!isDeleting">
            <polyline points="3,6 5,6 21,6"></polyline>
            <path d="M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <div class="loading-spinner" *ngIf="isDeleting"></div>
          {{ isDeleting ? 'Excluindo...' : 'Excluir Backend' }}
        </button>
        <button class="btn-secondary" (click)="testConnection()" [disabled]="isTestingConnection">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" *ngIf="!isTestingConnection">
            <path d="M9 12l2 2 4-4"></path>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
            <path d="M3 12h6m6 0h6"></path>
          </svg>
          <div class="loading-spinner" *ngIf="isTestingConnection"></div>
          {{ isTestingConnection ? 'Testando...' : 'Testar Conexão' }}
        </button>
        <button class="btn-primary" (click)="edit()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Editar Backend
        </button>
      </ng-container>

      <!-- MODO EDIÇÃO/CRIAÇÃO -->
      <ng-container *ngIf="isEditMode || isCreateMode">
        <button type="button" class="btn-secondary" (click)="testConnection()" [disabled]="isTestingConnection || backendForm.invalid">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" *ngIf="!isTestingConnection">
            <path d="M9 12l2 2 4-4"></path>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
            <path d="M3 12h6m6 0h6"></path>
          </svg>
          <div class="loading-spinner" *ngIf="isTestingConnection"></div>
          {{ isTestingConnection ? 'Testando...' : 'Testar Conexão' }}
        </button>
        <button type="button" class="btn-secondary" (click)="close()" [disabled]="isSubmitting">
          Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="save()" [disabled]="backendForm.invalid || isSubmitting">
          <div class="loading-spinner" *ngIf="isSubmitting"></div>
          {{ isSubmitting ? 'Salvando...' : (isCreateMode ? 'Criar Backend' : 'Salvar Alterações') }}
        </button>
      </ng-container>
    </div>